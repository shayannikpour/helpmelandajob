<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeetCode Questions - HelpMeLandAJob</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>

    <header>
        <a href="home.html">
            <h1>HelpMeLandAJob</h1>
        </a>
    </header>

    <nav>
        <ul>
            <li><a href="resume.html">Your Resume</a></li>
            <li><a href="skills.html">Skills</a></li>
            <li><a href="jobs.html">Job Recommendations</a></li>
            <li><a href="account.html">Account</a></li>
            <li><a href="leetcode.html">LeetCode</a></li>
        </ul>
    </nav>

    <div class="leetcode-container">
        <h1>LeetCode Question Recommendations</h1>

        <div class="selection-form">
            <form id="leetcodeForm">
                <div class="form-group">
                    <label>Programming Language:</label>
                    <select id="language" required>
                        <option value="">-- Select --</option>
                        <option>Python</option>
                        <option>JavaScript</option>
                        <option>Java</option>
                        <option>C++</option>
                        <option>C</option>
                        <option>C#</option>
                        <option>Go</option>
                        <option>Ruby</option>
                        <option>Swift</option>
                        <option>Kotlin</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Difficulty:</label>
                    <select id="difficulty" required>
                        <option value="">-- Select --</option>
                        <option>Easy</option>
                        <option>Medium</option>
                        <option>Hard</option>
                    </select>
                </div>

                <button class="submit-btn" id="submitBtn">Get Questions</button>
            </form>
        </div>

        <div id="loadingDiv" class="loading" style="display:none;">Loading...</div>
        <div id="errorDiv" class="error-message" style="display:none;"></div>
        <div id="questionsContainer"></div>
    </div>

    <footer>
        <p>&copy; 2025 HelpMeLandAJob</p>
    </footer>

    <script>
        const API_URL = "https://helpmelandajob-server.onrender.com/ai/leetcode";

        document.getElementById("leetcodeForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const lang = document.getElementById("language").value;
            const diff = document.getElementById("difficulty").value;
            const submitBtn = document.getElementById("submitBtn");
            const loadingDiv = document.getElementById("loadingDiv");
            const errorDiv = document.getElementById("errorDiv");
            const questionsContainer = document.getElementById("questionsContainer");

            errorDiv.style.display = "none";
            questionsContainer.innerHTML = "";
            loadingDiv.style.display = "block";
            submitBtn.disabled = true;

            const token = localStorage.getItem("token");
            if (!token) {
                loadingDiv.style.display = "none";
                submitBtn.disabled = false;
                errorDiv.textContent = "You must be logged in to use this feature.";
                errorDiv.style.display = "block";
                return;
            }

            if (!lang || !diff) {
                loadingDiv.style.display = "none";
                submitBtn.disabled = false;
                errorDiv.textContent = "Please select both language and difficulty.";
                errorDiv.style.display = "block";
                return;
            }

            // Drop JSON, use QUESTION/ANSWER markers instead – much more robust
            const prompt = `
You are generating LeetCode-style coding interview questions.

Respond in EXACTLY this format, with these two sections and nothing else:

QUESTION:
<problem statement, max 3 sentences, max 400 characters, for ${lang} at ${diff} difficulty>

ANSWER:
<complete working ${lang} solution code plus a 1–3 sentence explanation>

Rules:
- Do NOT include any JSON.
- Do NOT include markdown like \`\`\` fences.
- Do NOT repeat these instructions.
- Start the first line with "QUESTION:".
- Later, on a new line, start the answer section with "ANSWER:".
`;

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({ prompt })
                });

                if (!response.ok) {
                    const errText = await response.text().catch(() => "");
                    throw new Error(`Server error (${response.status}): ${errText || "Unable to get question"}`);
                }

                const data = await response.json();
                const raw = data?.choices?.[0]?.message?.content || "";
                console.log("AI RAW:", raw);

                if (!raw || typeof raw !== "string") {
                    throw new Error("Empty or invalid AI response.");
                }

                const qa = parseQuestionAnswer(raw);

                if (!qa || !qa.question) {
                    throw new Error("AI response was not in the expected format. Please try again.");
                }

                displayQuestions([qa]);

            } catch (err) {
                console.error(err);
                errorDiv.textContent = err.message || "Something went wrong.";
                errorDiv.style.display = "block";
            } finally {
                loadingDiv.style.display = "none";
                submitBtn.disabled = false;
            }
        });

        // Parse "QUESTION: ... ANSWER: ..." format
        function parseQuestionAnswer(raw) {
            const parts = raw.split(/ANSWER:/i);
            if (parts.length < 2) {
                return null;
            }

            const questionPart = parts[0].replace(/QUESTION:/i, "").trim();
            const answerPart = parts.slice(1).join("ANSWER:").trim(); // in case "ANSWER:" appears again

            // Basic sanity checks
            if (!questionPart || questionPart.length < 10) {
                return null;
            }

            return {
                question: questionPart,
                answer: answerPart || "No answer provided."
            };
        }

        function displayQuestions(questions) {
            const container = document.getElementById("questionsContainer");
            container.innerHTML = "";

            if (!Array.isArray(questions) || questions.length === 0) {
                container.innerHTML = '<div class="error-message">No questions returned.</div>';
                return;
            }

            questions.forEach((q, index) => {
                const card = document.createElement("div");
                card.className = "question-card";

                const id = `answer-${index}`;

                const questionText = q.question || "No question text provided.";
                const answerText = q.answer || "No answer provided.";

                card.innerHTML = `
                <h3>Question ${index + 1}</h3>
                <div class="question-content">${formatText(questionText)}</div>
                <button class="reveal-btn" onclick="toggleAnswer('${id}', this)">Reveal Answer</button>
                <div id="${id}" class="answer-content">${formatText(answerText)}</div>
            `;

                container.appendChild(card);
            });
        }

        function formatText(text) {
            if (!text) return "";
            // Preserve newlines from the model
            return text.replace(/\r\n/g, "\n").replace(/\n/g, "<br>");
        }

        function toggleAnswer(id, btn) {
            const box = document.getElementById(id);
            const open = box.classList.toggle("revealed");
            btn.textContent = open ? "Hide Answer" : "Reveal Answer";
        }
    </script>

</body>

</html>